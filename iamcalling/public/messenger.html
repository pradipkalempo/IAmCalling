<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Real-time Messenger</title>
    <!-- Mobile-First CSS -->
    <link rel="stylesheet" href="css/mobile-responsive.css">

    <link rel="stylesheet" href="css/messenger-realtime.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <div class="messenger-container">
        <!-- Conversations Sidebar -->
        <div class="conversations-sidebar">
            <div class="conversations-header">
                <h3><i class="fas fa-comments"></i> Messages</h3>
            </div>
            <div class="conversation-list" id="conversationList">
                <!-- Conversations will be populated here -->
                <div class="loading-spinner">
                    <div class="spinner"></div>
                </div>
            </div>
        </div>

        <!-- Chat Area -->
        <div class="chat-area">
            <div class="chat-header" id="chatHeader" style="display: none;">
                <div class="user-avatar">
                    <img src="/images/default-avatar.png" alt="User" id="chatUserAvatar">
                    <div class="online-status online" id="chatUserStatus"></div>
                </div>
                <div class="chat-user-info">
                    <h4 id="chatUserName">Select a conversation</h4>
                    <div class="chat-user-status" id="chatUserStatusText">Click on a conversation to start chatting</div>
                </div>
            </div>

            <div class="messages-container" id="messagesContainer">
                <div class="empty-state">
                    <i class="fas fa-comments"></i>
                    <h3>Welcome to Messenger</h3>
                    <p>Select a conversation to start chatting</p>
                </div>
            </div>

            <div class="message-input-area" id="messageInputArea" style="display: none;">
                <input 
                    type="text" 
                    class="message-input" 
                    id="messageInput" 
                    placeholder="Type a message..."
                    autocomplete="off"
                >
                <button class="send-button" id="sendButton">
                    <i class="fas fa-paper-plane"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- Notification -->
    <div class="notification" id="notification"></div>

    <!-- Scripts -->
    <script src="js/unified-messenger.js"></script>
    <script>
        // Enhanced messenger functionality
        class EnhancedMessenger {
            constructor() {
                this.currentUserId = null;
                this.setupEnhancedFeatures();
            }

            setupEnhancedFeatures() {
                // Auto-scroll to bottom when new messages arrive
                this.setupAutoScroll();
                
                // Handle typing indicators
                this.setupTypingIndicators();
                
                // Handle connection status
                this.setupConnectionStatus();
            }

            openConversation(conversationId) {
                // Update UI
                this.updateChatHeader(conversationId);
                this.showChatArea();
                this.markConversationAsActive(conversationId);
            }

            updateChatHeader(conversationId) {
                // Placeholder - needs to be adapted to unified messenger structure
                const chatHeader = document.getElementById('chatHeader');
                const chatUserName = document.getElementById('chatUserName');
                const chatUserAvatar = document.getElementById('chatUserAvatar');
                const chatUserStatusText = document.getElementById('chatUserStatusText');
                const chatUserStatus = document.getElementById('chatUserStatus');

                // This would need to be updated to work with unified messenger
                chatUserName.textContent = 'Selected User';
                chatUserAvatar.src = '/images/default-avatar.png';
                chatUserStatusText.textContent = 'Online';
                chatUserStatus.className = 'online-status online';
                
                chatHeader.style.display = 'flex';
            }

            showChatArea() {
                document.getElementById('messageInputArea').style.display = 'flex';
                document.querySelector('.empty-state').style.display = 'none';
            }

            markConversationAsActive(conversationId) {
                // Remove active class from all conversations
                document.querySelectorAll('.conversation-item').forEach(item => {
                    item.classList.remove('active');
                });
                
                // Add active class to selected conversation
                const activeItem = document.querySelector(`[data-conversation-id="${conversationId}"]`);
                if (activeItem) {
                    activeItem.classList.add('active');
                }
            }

            setupAutoScroll() {
                const messagesContainer = document.getElementById('messagesContainer');
                if (!messagesContainer) return;

                // Auto-scroll when new messages arrive
                const observer = new MutationObserver(() => {
                    messagesContainer.scrollTop = messagesContainer.scrollHeight;
                });

                observer.observe(messagesContainer, {
                    childList: true,
                    subtree: true
                });
            }

            setupTypingIndicators() {
                const messageInput = document.getElementById('messageInput');
                if (!messageInput) return;

                let typingTimer;
                
                messageInput.addEventListener('input', () => {
                    // Send typing indicator
                    this.sendTypingIndicator(true);
                    
                    clearTimeout(typingTimer);
                    typingTimer = setTimeout(() => {
                        this.sendTypingIndicator(false);
                    }, 1000);
                });
            }

            sendTypingIndicator(isTyping) {
                // Placeholder for typing indicator
                console.log('Typing indicator:', isTyping);
            }

            setupConnectionStatus() {
                window.addEventListener('online', () => {
                    this.showNotification('Connection restored', 'success');
                });

                window.addEventListener('offline', () => {
                    this.showNotification('Connection lost', 'error');
                });
            }

            showNotification(message, type = 'success') {
                const notification = document.getElementById('notification');
                notification.textContent = message;
                notification.className = `notification ${type} show`;
                
                setTimeout(() => {
                    notification.classList.remove('show');
                }, 3000);
            }
        }

        // Initialize enhanced messenger
        const messenger = new EnhancedMessenger();

        // Global function for conversation clicks
        window.openConversation = (conversationId) => {
            messenger.openConversation(conversationId);
        };
    </script>
</body>
</html>
