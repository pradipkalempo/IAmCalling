<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Global View Tracking Test</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            min-height: 100vh;
        }
        
        .test-container {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 30px;
            margin: 20px 0;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .view-counter {
            font-size: 48px;
            font-weight: bold;
            text-align: center;
            padding: 30px;
            background: linear-gradient(45deg, rgba(76, 175, 80, 0.3), rgba(33, 150, 243, 0.3));
            border-radius: 15px;
            margin: 20px 0;
            border: 2px solid #4CAF50;
            transition: all 0.3s ease;
        }
        
        .view-counter.updating {
            transform: scale(1.1);
            background: linear-gradient(45deg, rgba(255, 193, 7, 0.4), rgba(255, 152, 0, 0.4));
            border-color: #FFC107;
        }
        
        .test-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            justify-content: center;
            margin: 20px 0;
        }
        
        .test-button {
            background: linear-gradient(45deg, #2196F3, #21CBF3);
            color: white;
            border: none;
            padding: 15px 25px;
            border-radius: 30px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(33, 150, 243, 0.4);
        }
        
        .test-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(33, 150, 243, 0.6);
        }
        
        .test-button.danger {
            background: linear-gradient(45deg, #f44336, #ff6b6b);
            box-shadow: 0 4px 15px rgba(244, 67, 54, 0.4);
        }
        
        .test-button.danger:hover {
            box-shadow: 0 8px 25px rgba(244, 67, 54, 0.6);
        }
        
        .test-button.success {
            background: linear-gradient(45deg, #4CAF50, #8BC34A);
            box-shadow: 0 4px 15px rgba(76, 175, 80, 0.4);
        }
        
        .test-button.success:hover {
            box-shadow: 0 8px 25px rgba(76, 175, 80, 0.6);
        }
        
        .status-panel {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        
        .status-card {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            padding: 20px;
            border-left: 4px solid #4CAF50;
        }
        
        .status-card.error {
            border-left-color: #f44336;
        }
        
        .status-card.warning {
            border-left-color: #FFC107;
        }
        
        .log-container {
            background: #1e1e1e;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .log-entry {
            margin: 8px 0;
            padding: 8px;
            border-radius: 5px;
            font-family: 'Consolas', 'Courier New', monospace;
            font-size: 14px;
        }
        
        .log-info { background: rgba(76, 175, 80, 0.2); color: #4CAF50; }
        .log-warning { background: rgba(255, 193, 7, 0.2); color: #FFC107; }
        .log-error { background: rgba(244, 67, 54, 0.2); color: #f44336; }
        .log-success { background: rgba(33, 150, 243, 0.2); color: #2196F3; }
    </style>
</head>
<body>
    <h1>üåç Global View Tracking Test</h1>
    <p>Testing view count functionality across the entire system for global deployment</p>
    
    <div class="test-container">
        <h2>üìä Live View Counter</h2>
        <div class="view-counter" id="globalViewCount">0</div>
        <p style="text-align: center; color: #aaa;">
            This counter should increment with each test and persist across page reloads
        </p>
    </div>
    
    <div class="test-container">
        <h2>üéØ Testing Actions</h2>
        <div class="test-buttons">
            <button class="test-button" onclick="testSingleView()">üìà Track Single View</button>
            <button class="test-button" onclick="testBatchViews(5)">üìä Track 5 Views</button>
            <button class="test-button success" onclick="testRealPost()">üì∞ Test Real Post</button>
            <button class="test-button danger" onclick="resetCounter()">üîÑ Reset Counter</button>
            <button class="test-button" onclick="testCrossPage()">üîó Cross-Page Test</button>
        </div>
    </div>
    
    <div class="status-panel">
        <div class="status-card" id="systemStatus">
            <h3>üîß System Status</h3>
            <div>Initializing...</div>
        </div>
        
        <div class="status-card" id="networkStatus">
            <h3>üåê Network Status</h3>
            <div>Checking...</div>
        </div>
        
        <div class="status-card" id="storageStatus">
            <h3>üíæ Storage Status</h3>
            <div>Checking...</div>
        </div>
    </div>
    
    <div class="test-container">
        <h2>üìã Real-time Logs</h2>
        <div class="log-container" id="logContainer">
            <div class="log-entry log-info">[INFO] Global view tracking test initialized</div>
        </div>
        <div style="text-align: center; margin-top: 15px;">
            <button class="test-button" onclick="clearLogs()">Clear Logs</button>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="storage-fix.js"></script>
    <script src="js/view-tracker-fixed.js"></script>
    
    <script>
        // Supabase configuration
        const SUPABASE_URL = window.APP_CONFIG?.supabaseUrl || '';
        const SUPABASE_ANON_KEY = window.APP_CONFIG?.supabaseAnonKey || '';
        
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        let globalViewCount = 0;
        const testPostId = 'global-test-' + Date.now();
        
        // DOM elements
        const viewCountEl = document.getElementById('globalViewCount');
        const logContainer = document.getElementById('logContainer');
        
        // Logging function
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry log-${type}`;
            logEntry.innerHTML = `[${timestamp}] ${message}`;
            logContainer.appendChild(logEntry);
            logContainer.scrollTop = logContainer.scrollHeight;
            
            console.log(`[Global Test] ${message}`);
        }
        
        // Clear logs
        function clearLogs() {
            logContainer.innerHTML = '';
            log('Logs cleared', 'info');
        }
        
        // Update status cards
        function updateStatus(cardId, title, content, status = 'ok') {
            const card = document.getElementById(cardId);
            card.innerHTML = `<h3>${title}</h3><div>${content}</div>`;
            card.className = `status-card ${status === 'error' ? 'error' : status === 'warning' ? 'warning' : ''}`;
        }
        
        // Update view counter with animation
        function updateViewCounter(newValue) {
            globalViewCount = newValue;
            viewCountEl.textContent = globalViewCount;
            
            // Add animation
            viewCountEl.classList.add('updating');
            setTimeout(() => {
                viewCountEl.classList.remove('updating');
            }, 300);
            
            // Store in localStorage for persistence
            try {
                localStorage.setItem('globalViewTestCount', globalViewCount.toString());
            } catch (e) {
                // Storage blocked, use memory fallback
            }
        }
        
        // Test single view tracking
        async function testSingleView() {
            log('Testing single view tracking...', 'info');
            
            try {
                if (window.ViewTracker) {
                    const result = await window.ViewTracker.trackView(testPostId, 'post');
                    if (result.view_counts) {
                        updateViewCounter(globalViewCount + 1);
                        log(`‚úÖ View tracked successfully: ${result.view_counts.total_views} total views`, 'success');
                    } else {
                        log('‚ö†Ô∏è View tracked but no count returned', 'warning');
                    }
                } else {
                    log('‚ùå ViewTracker not available', 'error');
                    updateStatus('systemStatus', 'üîß System Status', 'ViewTracker not initialized', 'error');
                }
            } catch (error) {
                log(`‚ùå Error tracking view: ${error.message}`, 'error');
                updateStatus('systemStatus', 'üîß System Status', `Error: ${error.message}`, 'error');
            }
        }
        
        // Test batch views
        async function testBatchViews(count) {
            log(`Testing batch view tracking (${count} views)...`, 'info');
            
            for (let i = 0; i < count; i++) {
                await new Promise(resolve => setTimeout(resolve, 200));
                await testSingleView();
            }
        }
        
        // Test with real post
        async function testRealPost() {
            log('Testing with real post ID...', 'info');
            
            try {
                // Try to get a real post
                const { data: posts } = await supabaseClient
                    .from('posts')
                    .select('id')
                    .limit(1);
                
                if (posts && posts.length > 0) {
                    const realPostId = posts[0].id;
                    log(`Using real post ID: ${realPostId}`, 'info');
                    
                    if (window.ViewTracker) {
                        const result = await window.ViewTracker.trackView(realPostId, 'post');
                        if (result.view_counts) {
                            updateViewCounter(globalViewCount + 1);
                            log(`‚úÖ Real post view tracked: ${result.view_counts.total_views} views`, 'success');
                        }
                    }
                } else {
                    log('‚ö†Ô∏è No real posts found, using test post', 'warning');
                    await testSingleView();
                }
            } catch (error) {
                log(`‚ùå Error with real post test: ${error.message}`, 'error');
                await testSingleView(); // Fallback to test post
            }
        }
        
        // Reset counter
        function resetCounter() {
            globalViewCount = 0;
            updateViewCounter(0);
            log('üîÑ Counter reset to zero', 'info');
            
            try {
                localStorage.removeItem('globalViewTestCount');
            } catch (e) {
                // Storage blocked
            }
        }
        
        // Cross-page test
        function testCrossPage() {
            log('üîó Testing cross-page functionality...', 'info');
            
            // Store current state
            const testState = {
                count: globalViewCount,
                timestamp: Date.now()
            };
            
            try {
                localStorage.setItem('crossPageTest', JSON.stringify(testState));
                log('‚úÖ Test state saved to storage', 'success');
                
                // Open test page in new tab
                window.open('live-debug.html', '_blank');
                log('üìù Cross-page test page opened', 'info');
                
            } catch (error) {
                log(`‚ùå Cross-page test failed: ${error.message}`, 'error');
            }
        }
        
        // Initialize system status
        async function initializeSystem() {
            // Check ViewTracker
            setTimeout(() => {
                if (window.ViewTracker) {
                    updateStatus('systemStatus', 'üîß System Status', '‚úÖ ViewTracker ready', 'ok');
                    log('‚úÖ ViewTracker detected and initialized', 'success');
                } else {
                    updateStatus('systemStatus', 'üîß System Status', '‚ö†Ô∏è ViewTracker initializing...', 'warning');
                    log('‚ö†Ô∏è ViewTracker not detected, waiting for initialization', 'warning');
                }
            }, 1000);
            
            // Check network
            try {
                const response = await fetch('https://httpbin.org/get?test=network');
                if (response.ok) {
                    updateStatus('networkStatus', 'üåê Network Status', '‚úÖ Connected', 'ok');
                    log('‚úÖ Network connectivity confirmed', 'success');
                } else {
                    updateStatus('networkStatus', 'üåê Network Status', `‚ö†Ô∏è Issues (${response.status})`, 'warning');
                    log(`‚ö†Ô∏è Network response: ${response.status}`, 'warning');
                }
            } catch (error) {
                updateStatus('networkStatus', 'üåê Network Status', '‚ùå Disconnected', 'error');
                log(`‚ùå Network error: ${error.message}`, 'error');
            }
            
            // Check storage
            try {
                const testKey = 'storage_test_' + Date.now();
                localStorage.setItem(testKey, 'test');
                localStorage.removeItem(testKey);
                updateStatus('storageStatus', 'üíæ Storage Status', '‚úÖ Available', 'ok');
                log('‚úÖ Storage system working', 'success');
            } catch (error) {
                updateStatus('storageStatus', 'üíæ Storage Status', '‚ö†Ô∏è Limited (fallback active)', 'warning');
                log('‚ö†Ô∏è Storage limited, using fallback', 'warning');
            }
            
            // Load previous count
            try {
                const savedCount = localStorage.getItem('globalViewTestCount');
                if (savedCount) {
                    globalViewCount = parseInt(savedCount) || 0;
                    updateViewCounter(globalViewCount);
                    log(`üìä Loaded previous count: ${globalViewCount}`, 'info');
                }
            } catch (e) {
                // Storage blocked
            }
            
            // Periodic status updates
            setInterval(() => {
                if (window.ViewTracker) {
                    const trackedCount = window.ViewTracker.trackedContent?.size || 0;
                    updateStatus('systemStatus', 'üîß System Status', 
                        `‚úÖ Active (${trackedCount} items tracked)`, 'ok');
                }
            }, 10000);
        }
        
        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', () => {
            log('üåç Global view tracking test started', 'info');
            initializeSystem();
        });
        
        // Capture ViewTracker logs
        const originalConsoleLog = console.log;
        console.log = function() {
            const args = Array.from(arguments);
            const message = args.join(' ');
            if (message.includes('View tracked') || message.includes('Loaded initial view counts')) {
                log(message, 'success');
            }
            originalConsoleLog.apply(console, arguments);
        };
        
        const originalConsoleError = console.error;
        console.error = function() {
            const args = Array.from(arguments);
            const message = args.join(' ');
            if (message.includes('Error tracking view')) {
                log(`‚ùå ${message}`, 'error');
            }
            originalConsoleError.apply(console, arguments);
        };
    </script>
</body>
</html>