<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug Article Content</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
    <div style="padding: 20px; font-family: Arial, sans-serif;">
        <h1>Debug Article Content Loading</h1>
        <div id="debug-info"></div>
        <div id="content-container" style="margin-top: 20px; border: 1px solid #ccc; padding: 15px; min-height: 200px;"></div>
    </div>

    <script>
        // Supabase configuration
        const SUPABASE_URL = window.APP_CONFIG?.supabaseUrl || '';
        const SUPABASE_ANON_KEY = window.APP_CONFIG?.supabaseAnonKey || '';
        
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        const debugInfo = document.getElementById('debug-info');
        const contentContainer = document.getElementById('content-container');

        function log(message) {
            console.log(message);
            debugInfo.innerHTML += `<div>${message}</div>`;
        }

        // Get post ID from URL
        function getPostId() {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get('id') || '100'; // Default to post 100 for testing
        }

        // Test the exact autoCorrectCodeContent function from article detail page
        function autoCorrectCodeContent(content) {
            log('üîç Testing autoCorrectCodeContent function...');
            log(`Content length: ${content.length} characters`);
            
            // Remove any duplicate wrappers
            let cleanedContent = content;
            
            // Handle multiple code blocks - extract the main one
            const codeBlocks = cleanedContent.match(/<div\s+class=["']admin-code-executable["'][^>]*>([\s\S]*?)<\/div>/gi);
            
            log(`Code blocks found: ${codeBlocks ? codeBlocks.length : 0}`);
            
            if (codeBlocks && codeBlocks.length > 0) {
                // Use the first/main code block
                const mainCodeBlock = codeBlocks[0].match(/<div\s+class=["']admin-code-executable["'][^>]*>([\s\S]*?)<\/div>/i);
                if (mainCodeBlock && mainCodeBlock[1]) {
                    log('‚úÖ Successfully extracted code content');
                    log(`Extracted content length: ${mainCodeBlock[1].length} characters`);
                    return mainCodeBlock[1];
                }
            }
            
            // If no specific code block found, return the content as-is but clean it
            const cleaned = cleanedContent
                .replace(/<!--.*?-->/g, '') // Remove comments
                .replace(/^\s+|\s+$/g, '') // Trim whitespace
                .trim();
                
            log('‚ÑπÔ∏è No code blocks found, returning cleaned content');
            log(`Cleaned content length: ${cleaned.length} characters`);
            return cleaned;
        }

        // Fetch and test post
        async function testPostContent() {
            const postId = getPostId();
            log(`üîç Testing post ID: ${postId}`);
            
            try {
                const { data: post, error } = await supabaseClient
                    .from('posts')
                    .select('*')
                    .eq('id', postId)
                    .single();
                
                if (error) {
                    log(`‚ùå Error fetching post: ${error.message}`);
                    return;
                }
                
                if (!post) {
                    log('‚ùå Post not found');
                    return;
                }
                
                log(`‚úÖ Post found: ${post.title}`);
                log(`Author: ${post.author_name || post.author || 'Unknown'}`);
                log(`Content length: ${post.content.length} characters`);
                
                // Test the content extraction
                const extractedContent = autoCorrectCodeContent(post.content);
                
                // Display the extracted content
                contentContainer.innerHTML = `
                    <h3>Extracted Content:</h3>
                    <div style="background: #f5f5f5; padding: 10px; border-radius: 4px; white-space: pre-wrap; font-family: monospace; max-height: 300px; overflow-y: auto;">
                        ${extractedContent}
                    </div>
                    <h3 style="margin-top: 20px;">Content Preview:</h3>
                    <div style="background: #e8f4fd; padding: 10px; border-radius: 4px;">
                        ${extractedContent.substring(0, 500)}${extractedContent.length > 500 ? '...' : ''}
                    </div>
                `;
                
                log('‚úÖ Content extraction and display completed');
                
            } catch (error) {
                log(`‚ùå Error: ${error.message}`);
            }
        }

        // Run test when page loads
        document.addEventListener('DOMContentLoaded', testPostContent);
    </script>
</body>
</html>