<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Create Admin Post - IAmCalling</title>
    <link rel="stylesheet" href="css/fontawesome-all.min.css">
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="admin-style.css">
    <link rel="stylesheet" href="mobile-responsive.css">
    <style>
        body {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            color: #ffffff;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 30px;
        }
        
        h1 {
            color: #ffffff;
            text-align: center;
            margin-bottom: 30px;
        }
        
        .form-container {
            background: rgba(255, 255, 255, 0.08);
            border-radius: 12px;
            padding: 25px;
            border: 1px solid rgba(255, 255, 255, 0.15);
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-label {
            color: #ffffff;
            font-weight: 500;
            margin-bottom: 8px;
            display: block;
        }
        
        .form-input, select {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 8px;
            padding: 12px;
            color: #ffffff;
            width: 100%;
            margin-bottom: 15px;
            font-size: 16px;
        }
        
        .form-input, select {
            background: rgba(255, 255, 255, 0.9);
            color: #333;
        }
        
        select option {
            background: #ffffff;
            color: #333;
        }
        
        .form-input:focus, select:focus {
            outline: none;
            border-color: #ff6b6b;
            box-shadow: 0 0 0 3px rgba(255, 107, 107, 0.3);
        }
        
        .code-editor-section {
            background: rgba(0,0,0,0.3);
            border-radius: 8px;
            padding: 20px;
            margin-top: 15px;
            display: none;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .code-editor-section.active {
            display: block;
        }
        
        .code-editor {
            width: 100%;
            min-height: 200px;
            background: #1a1a1a;
            color: #ffffff;
            border: 1px solid #444444;
            border-radius: 4px;
            padding: 12px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            margin-bottom: 15px;
            resize: vertical;
        }
        
        .preview-container {
            background: #1a1a1a;
            border: 1px solid #444444;
            border-radius: 4px;
            min-height: 300px;
            margin-top: 15px;
            display: none;
        }
        
        .preview-container.active {
            display: block;
        }
        
        .code-preview {
            width: 100%;
            height: 300px;
            border: none;
            background: #ffffff;
        }
        
        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 5px;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #ff6b6b, #ee5a52);
            color: white;
        }
        
        .btn-secondary {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }
        
        .btn-group {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            flex-wrap: wrap;
        }
        
        .checkbox-group {
            display: flex;
            align-items: center;
            margin: 15px 0;
        }
        
        .checkbox-group input[type="checkbox"] {
            margin-right: 10px;
            width: 18px;
            height: 18px;
            accent-color: #ff6b6b;
        }
        
        .checkbox-group label {
            color: #ffffff;
            font-weight: 500;
            cursor: pointer;
        }
        
        @media (max-width: 768px) {
            .container {
                margin: 15px;
                padding: 20px;
            }
            
            .btn-group {
                flex-direction: column;
            }
            
            .btn {
                width: 100%;
                margin: 5px 0;
            }
        }
    </style>
    <script src="/config.js"></script>
    <script>
        function previewCode() {
            const code = document.getElementById('unifiedCode').value;
            if (!code) {
                alert('Please enter some code to preview');
                return;
            }
            const previewContainer = document.getElementById('previewContainer');
            const codePreview = document.getElementById('codePreview');
            const fullHTML = `<!DOCTYPE html><html><head><meta charset="UTF-8"><title>Preview</title><style>body{margin:0;padding:20px;font-family:Arial,sans-serif}*{box-sizing:border-box}</style></head><body>${code}</body></html>`;
            const iframeDoc = codePreview.contentDocument || codePreview.contentWindow.document;
            iframeDoc.open();
            iframeDoc.write(fullHTML);
            iframeDoc.close();
            previewContainer.classList.add('active');
        }
        function clearThumbnail() {
            document.getElementById('thumbnailUpload').value = '';
            document.getElementById('thumbnailPreviewImg').src = '';
            document.getElementById('thumbnailPreview').style.display = 'none';
        }
        function saveDraft() {
            const formData = {
                title: document.getElementById('postTitle').value.trim(),
                content: document.getElementById('unifiedCode').value,
                category: document.getElementById('category').value
            };
            try {
                localStorage.setItem('admin_post_draft', JSON.stringify(formData));
                alert('Draft saved successfully!');
            } catch (error) {
                alert('Draft could not be saved');
            }
        }
    </script>
</head>
<body>
    <div id="universal-topbar-placeholder"></div>
    
    <div class="container">
        <div class="form-container">
            <h1><i class="fas fa-pen-alt"></i> Create Admin Post</h1>
            
            <form id="adminPostForm">
                <div class="form-group">
                    <label class="form-label">Post Title *</label>
                    <input type="text" id="postTitle" class="form-input" placeholder="Enter post title" required>
                </div>

                <div class="form-group">
                    <label class="form-label">Code Content (Required)</label>
                    <div style="background: rgba(0,0,0,0.2); border-radius: 8px; padding: 20px; margin-top: 10px;">
                        <div id="codeEditorSection" class="code-editor-section active">
                            <div class="form-group">
                                <label class="form-label">Code (HTML/CSS/JS)</label>
                                <textarea id="unifiedCode" class="code-editor" placeholder="Enter your full HTML/JS/CSS code here..." style="min-height: 400px;"></textarea>
                            </div>
                            
                            <div class="btn-group">
                                <button type="button" class="btn btn-secondary" onclick="previewCode()">
                                    <i class="fas fa-eye"></i> Preview Code
                                </button>
                            </div>
                            
                            <div id="previewContainer" class="preview-container">
                                <iframe id="codePreview" class="code-preview"></iframe>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Hidden content section for backward compatibility -->
                <div style="display: none;">
                    <div id="editor" style="height: 300px;"></div>
                    <textarea id="postContent"></textarea>
                    <div class="char-count">
                        <span id="charCount">0</span> characters
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">Thumbnail Image (Optional)</label>
                    <input type="file" id="thumbnailUpload" class="form-input" accept="image/*" style="padding: 8px;">
                    <div id="thumbnailPreview" style="margin-top: 10px; display: none;">
                        <img id="thumbnailPreviewImg" src="" alt="Thumbnail Preview" style="max-width: 200px; max-height: 150px; border-radius: 8px; border: 2px solid rgba(255, 255, 255, 0.3);">
                        <button type="button" class="btn btn-secondary" style="margin-top: 10px;" onclick="clearThumbnail()">
                            <i class="fas fa-trash"></i> Clear Image
                        </button>
                    </div>
                    <p style="color: #aaa; font-size: 14px; margin-top: 5px;">Upload a thumbnail image for your post (JPG, PNG, GIF)</p>
                </div>

                <div class="form-group">
                    <label class="form-label">Challenge ID (Optional)</label>
                    <input type="text" id="challengeId" class="form-input" placeholder="Enter challenge ID to connect related articles">
                </div>

                <div class="form-group">
                    <label class="form-label">Category *</label>
                    <select id="category" class="form-input" required>
                        <option value="">Select category</option>
                        <option value="innovation-tech">Innovation and Tech</option>
                        <option value="biology">Biology</option>
                        <option value="geography">Geography</option>
                        <option value="history">History</option>
                        <option value="ethics-morality">Ethics & Morality</option>
                        <option value="justice">Justice</option>
                        <option value="religious-truth">Religious Truth</option>
                        <option value="fact-check">Fact Check</option>
                        <option value="politics">Politics</option>
                    </select>
                </div>

                <div class="checkbox-group">
                    <input type="checkbox" id="isOfficial" checked>
                    <label for="isOfficial">Official Post</label>
                </div>

                <div class="checkbox-group">
                    <input type="checkbox" id="allowComments" checked>
                    <label for="allowComments">Allow Comments</label>
                </div>

                <div class="btn-group">
                    <button type="button" class="btn btn-secondary" onclick="saveDraft()">
                        <i class="fas fa-save"></i> Save Draft
                    </button>
                    <button type="submit" id="publishBtn" class="btn btn-primary">
                        <i class="fas fa-paper-plane"></i> Publish Post
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script src="https://cdn.quilljs.com/1.3.6/quill.min.js"></script>
    <script src="js/universal-topbar.js"></script>
    <script>
        let quill;

        function handleThumbnailUpload(event) {
            const file = event.target.files[0];
            if (file) {
                if (!file.type.match('image.*')) {
                    alert('Please select an image file (JPG, PNG, GIF)');
                    event.target.value = '';
                    return;
                }
                
                if (file.size > 5 * 1024 * 1024) {
                    alert('File size too large. Please select an image under 5MB');
                    event.target.value = '';
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('thumbnailPreviewImg').src = e.target.result;
                    document.getElementById('thumbnailPreview').style.display = 'block';
                };
                reader.readAsDataURL(file);
            }
        }

        function initializeEditor() {
            quill = new Quill('#editor', {
                theme: 'snow',
                modules: {
                    toolbar: [
                        [{ 'header': [1, 2, 3, false] }],
                        ['bold', 'italic', 'underline'],
                        [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                        ['link', 'image'],
                        ['clean']
                    ]
                },
                placeholder: 'Write your post content here...'
            });

            quill.on('text-change', function() {
                const content = quill.root.innerHTML;
                document.getElementById('postContent').value = content;
                const textContent = quill.getText();
                document.getElementById('charCount').textContent = textContent.length;
            });
        }

        document.getElementById('adminPostForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const publishBtn = document.getElementById('publishBtn');
            publishBtn.disabled = true;
            publishBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Publishing...';
            
            try {
                let thumbnailData = null;
                const thumbnailFile = document.getElementById('thumbnailUpload').files[0];
                if (thumbnailFile) {
                    const reader = new FileReader();
                    thumbnailData = await new Promise((resolve) => {
                        reader.onload = (e) => resolve(e.target.result);
                        reader.readAsDataURL(thumbnailFile);
                    });
                }

                let processedContent = '';
                const unifiedCode = document.getElementById('unifiedCode').value;
                if (unifiedCode) {
                    processedContent = `<div class="admin-code-executable" style="margin: 20px 0; padding: 15px; background: #f9f9f9; border-radius: 8px; border: 1px solid #ddd;">${unifiedCode}</div>`;
                } else {
                    processedContent = '<div class="admin-code-executable" style="margin: 20px 0;"><p>No content provided</p></div>';
                }
                
                const plainText = unifiedCode.replace(/<[^>]*>/g, '').substring(0, 200);

                const formData = {
                    title: document.getElementById('postTitle').value.trim(),
                    content: processedContent,
                    plain_text: plainText || 'No content',
                    category: document.getElementById('category').value,
                    challenge_post_id: document.getElementById('challengeId').value.trim() || null,
                    thumbnail_url: thumbnailData,
                    is_official: document.getElementById('isOfficial').checked,
                    allow_comments: document.getElementById('allowComments').checked,
                    author_name: 'Admin',
                    author_role: 'admin',
                    published: true,
                    is_draft: false,
                    visibility: 'public',
                    post_type: 'admin',
                    priority: '0',
                    is_pinned: false,
                    likes_count: 0,
                    comments_count: 0,
                    views_count: 0,
                    created_at: new Date().toISOString()
                };

                if (!formData.title) {
                    throw new Error('Please enter a post title');
                }
                if (!formData.category) {
                    throw new Error('Please select a category');
                }
                if (unifiedCode.length < 10) {
                    throw new Error('Please enter at least 10 characters of code');
                }

                // Get Supabase config
                let config;
                try {
                    const configResponse = await fetch('/config');
                    config = await configResponse.json();
                } catch (e) {
                    // Fallback config
                    config = {
                        supabaseUrl: 'https://gkckyyyaoqsaouemjnxl.supabase.co',
                        supabaseAnonKey: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdrY2t5eXlhb3FzYW91ZW1qbnhsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTcyMzA3OTEsImV4cCI6MjA3MjgwNjc5MX0.0z5c-3P1fMSW2qiWg7IT3Oqv-65B3lZ8Lsq2aDvMYQk'
                    };
                }
                
                const response = await fetch(`${config.supabaseUrl}/rest/v1/posts`, {
                    method: 'POST',
                    headers: {
                        'apikey': config.supabaseAnonKey,
                        'Authorization': `Bearer ${config.supabaseAnonKey}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(formData)
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`HTTP ${response.status}: ${errorText}`);
                }

                alert('Post published successfully!');
                window.location.href = '01-index.html';

            } catch (error) {
                console.error('Error publishing post:', error);
                alert('Error publishing post: ' + error.message);
                publishBtn.disabled = false;
                publishBtn.innerHTML = '<i class="fas fa-paper-plane"></i> Publish Post';
            }
        });

        document.addEventListener('DOMContentLoaded', function() {
            initializeEditor();
            document.getElementById('thumbnailUpload').addEventListener('change', handleThumbnailUpload);
        });
    </script>
</body>
</html>