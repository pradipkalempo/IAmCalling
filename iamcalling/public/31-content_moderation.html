<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Content Moderation - Admin Panel</title>
    <!-- Mobile-First CSS -->
    <link rel="stylesheet" href="css/mobile-responsive.css">

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <style>
        :root {
            --primary-gradient: linear-gradient(135deg, #0f1b3d 0%, #1a3668 50%, #2a4a8a 100%);
            --glass-bg: rgba(15, 27, 61, 0.7);
            --glass-border: rgba(106, 153, 255, 0.3);
            --text-primary: #e6f0ff;
            --text-secondary: #a0c0ff;
            --success: #4caf50;
            --warning: #ff9800;
            --error: #f44336;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--primary-gradient);
            color: var(--text-primary);
            min-height: 100vh;
            padding: 80px 20px 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2rem;
            background: linear-gradient(45deg, #4a6fc5, #6b8ddf);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }

        .filters {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .filter-btn {
            padding: 8px 16px;
            border: 1px solid var(--glass-border);
            background: var(--glass-bg);
            color: var(--text-primary);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .filter-btn.active {
            background: linear-gradient(135deg, #4a6fc5, #6b8ddf);
            border-color: #6b8ddf;
        }

        .content-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(400px, 1fr));
            gap: 20px;
        }

        .content-card {
            background: var(--glass-bg);
            backdrop-filter: blur(10px);
            border: 1px solid var(--glass-border);
            border-radius: 15px;
            padding: 20px;
            transition: transform 0.3s ease;
        }

        .content-card:hover {
            transform: translateY(-5px);
        }

        .content-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 15px;
        }

        .content-type {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .type-post {
            background: rgba(76, 175, 80, 0.2);
            color: #4caf50;
        }

        .type-article {
            background: rgba(33, 150, 243, 0.2);
            color: #2196f3;
        }

        .content-title {
            font-size: 1.2rem;
            margin-bottom: 10px;
            color: var(--text-primary);
            line-height: 1.3;
        }

        .content-preview {
            color: var(--text-secondary);
            font-size: 0.9rem;
            line-height: 1.4;
            margin-bottom: 15px;
            max-height: 60px;
            overflow: hidden;
        }

        .content-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            font-size: 0.8rem;
            color: var(--text-secondary);
        }

        .content-actions {
            display: flex;
            gap: 10px;
        }

        .btn {
            padding: 6px 12px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.8rem;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }

        .btn-hide {
            background: linear-gradient(135deg, #ff9800, #ffb74d);
            color: white;
        }

        .btn-delete {
            background: linear-gradient(135deg, #f44336, #ef5350);
            color: white;
        }

        .btn-view {
            background: linear-gradient(135deg, #4a6fc5, #6b8ddf);
            color: white;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }

        .status-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .status-visible {
            background: rgba(76, 175, 80, 0.2);
            color: #4caf50;
        }

        .status-hidden {
            background: rgba(255, 152, 0, 0.2);
            color: #ff9800;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: var(--text-secondary);
        }

        .stats {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: var(--glass-bg);
            padding: 15px 20px;
            border-radius: 10px;
            border: 1px solid var(--glass-border);
            text-align: center;
            min-width: 120px;
        }

        .stat-number {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--text-primary);
        }

        .stat-label {
            font-size: 0.8rem;
            color: var(--text-secondary);
        }

        @media (max-width: 768px) {
            .content-grid {
                grid-template-columns: 1fr;
            }
            
            .filters {
                flex-direction: column;
            }
            
            .stats {
                flex-wrap: wrap;
            }
        }
    </style>
    <script src="js/universal-topbar-injector.js"></script>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1><i class="fas fa-shield-alt"></i> Content Moderation</h1>
            <a href="40-admin-dashboard-simple.html" class="btn btn-view">
                <i class="fas fa-arrow-left"></i> Back to Dashboard
            </a>
        </div>

        <div class="stats" id="stats">
            <div class="stat-card">
                <div class="stat-number" id="totalPosts">0</div>
                <div class="stat-label">Posts</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="totalArticles">0</div>
                <div class="stat-label">Articles</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="hiddenContent">0</div>
                <div class="stat-label">Hidden</div>
            </div>
        </div>

        <div class="filters">
            <button class="filter-btn active" data-filter="all">All Content</button>
            <button class="filter-btn" data-filter="posts">Posts Only</button>
            <button class="filter-btn" data-filter="articles">Articles Only</button>
            <button class="filter-btn" data-filter="hidden">Hidden Content</button>
            <button class="filter-btn" data-filter="recent">Recent (24h)</button>
        </div>

        <div class="content-grid" id="contentGrid">
            <div class="loading">
                <i class="fas fa-spinner fa-spin"></i> Loading content...
            </div>
        </div>
    </div>

    <script src="js/supabase-client.js"></script>
    <script>
        let allContent = [];
        let currentFilter = 'all';

        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(() => {
                loadContent();
            }, 2000);
            
            // Filter buttons
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    currentFilter = this.dataset.filter;
                    filterContent();
                });
            });
        });

        async function loadContent() {
            try {
                if (!window.supabaseClient) {
                    document.getElementById('contentGrid').innerHTML = 
                        '<div class="loading">Supabase client not available</div>';
                    return;
                }

                // Load posts and articles
                const [postsResult, articlesResult] = await Promise.all([
                    window.supabaseClient.from('posts').select('*').order('created_at', { ascending: false }),
                    window.supabaseClient.from('articles').select('*').order('created_at', { ascending: false })
                ]);

                const posts = (postsResult.data || []).map(item => ({ ...item, type: 'post' }));
                const articles = (articlesResult.data || []).map(item => ({ ...item, type: 'article' }));

                allContent = [...posts, ...articles].sort((a, b) => new Date(b.created_at) - new Date(a.created_at));

                updateStats();
                filterContent();

            } catch (error) {
                console.error('Error loading content:', error);
                document.getElementById('contentGrid').innerHTML = 
                    '<div class="loading">Error loading content</div>';
            }
        }

        function updateStats() {
            const posts = allContent.filter(item => item.type === 'post');
            const articles = allContent.filter(item => item.type === 'article');
            const hidden = allContent.filter(item => item.published === false);

            document.getElementById('totalPosts').textContent = posts.length;
            document.getElementById('totalArticles').textContent = articles.length;
            document.getElementById('hiddenContent').textContent = hidden.length;
        }

        function filterContent() {
            let filtered = allContent;

            switch(currentFilter) {
                case 'posts':
                    filtered = allContent.filter(item => item.type === 'post');
                    break;
                case 'articles':
                    filtered = allContent.filter(item => item.type === 'article');
                    break;
                case 'hidden':
                    filtered = allContent.filter(item => item.published === false);
                    break;
                case 'recent':
                    const yesterday = new Date(Date.now() - 24 * 60 * 60 * 1000);
                    filtered = allContent.filter(item => new Date(item.created_at) > yesterday);
                    break;
            }

            renderContent(filtered);
        }

        function renderContent(content) {
            const grid = document.getElementById('contentGrid');
            
            if (content.length === 0) {
                grid.innerHTML = '<div class="loading">No content found</div>';
                return;
            }

            grid.innerHTML = content.map(item => `
                <div class="content-card" data-id="${item.id}" data-type="${item.type}">
                    <div class="content-header">
                        <span class="content-type type-${item.type}">${item.type.toUpperCase()}</span>
                        <span class="status-badge ${item.published ? 'status-visible' : 'status-hidden'}">
                            ${item.published ? 'Visible' : 'Hidden'}
                        </span>
                    </div>
                    <h3 class="content-title">${item.title || 'Untitled'}</h3>
                    <div class="content-preview">${stripHtml(item.content || '').substring(0, 150)}...</div>
                    <div class="content-meta">
                        <span>By: ${item.author_name || 'Anonymous'}</span>
                        <span>${new Date(item.created_at).toLocaleDateString()}</span>
                    </div>
                    <div class="content-actions">
                        <button class="btn btn-view" onclick="viewContent(${item.id}, '${item.type}')">
                            <i class="fas fa-eye"></i> View
                        </button>
                        <button class="btn btn-hide" onclick="toggleVisibility(${item.id}, '${item.type}', ${item.published})">
                            <i class="fas fa-eye-slash"></i> ${item.published ? 'Hide' : 'Show'}
                        </button>
                        <button class="btn btn-delete" onclick="deleteContent(${item.id}, '${item.type}')">
                            <i class="fas fa-trash"></i> Delete
                        </button>
                    </div>
                </div>
            `).join('');
        }

        function stripHtml(html) {
            const tmp = document.createElement('div');
            tmp.innerHTML = html;
            return tmp.textContent || tmp.innerText || '';
        }

        function viewContent(id, type) {
            console.log('View clicked - ID:', id, 'Type:', type);
            // Redirect to appropriate page based on content type
            if (type === 'article') {
                console.log('Opening article detail page');
                window.open(`08-article-detail.html?id=${id}`, '_blank');
            } else {
                console.log('Opening post readmore page');
                window.open(`07-readmore.html?id=${id}`, '_blank');
            }
        }

        async function toggleVisibility(id, type, currentlyPublished) {
            try {
                const newStatus = !currentlyPublished;
                const table = type === 'post' ? 'posts' : 'articles';
                
                const { error } = await window.supabaseClient
                    .from(table)
                    .update({ published: newStatus })
                    .eq('id', id);

                if (error) throw error;

                // Update local data
                const item = allContent.find(item => item.id === id && item.type === type);
                if (item) item.published = newStatus;

                updateStats();
                filterContent();
                showNotification(`Content ${newStatus ? 'shown' : 'hidden'} successfully`, 'success');

            } catch (error) {
                console.error('Error updating visibility:', error);
                showNotification('Error updating visibility', 'error');
            }
        }

        async function deleteContent(id, type) {
            if (!confirm('Are you sure you want to delete this content? This action cannot be undone.')) {
                return;
            }

            try {
                const table = type === 'post' ? 'posts' : 'articles';
                
                const { error } = await window.supabaseClient
                    .from(table)
                    .delete()
                    .eq('id', id);

                if (error) throw error;

                // Remove from local data
                allContent = allContent.filter(item => !(item.id === id && item.type === type));

                updateStats();
                filterContent();
                showNotification('Content deleted successfully', 'success');

            } catch (error) {
                console.error('Error deleting content:', error);
                showNotification('Error deleting content', 'error');
            }
        }

        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 15px 20px;
                border-radius: 8px;
                color: white;
                font-weight: 500;
                z-index: 1000;
                transform: translateX(100%);
                transition: transform 0.3s ease;
                ${type === 'success' ? 'background: #4caf50;' : 'background: #f44336;'}
            `;
            notification.textContent = message;
            document.body.appendChild(notification);

            setTimeout(() => notification.style.transform = 'translateX(0)', 100);
            setTimeout(() => {
                notification.style.transform = 'translateX(100%)';
                setTimeout(() => document.body.removeChild(notification), 300);
            }, 3000);
        }
    </script>
</body>
</html>
