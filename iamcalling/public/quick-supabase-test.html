<!DOCTYPE html>
<html>
<head>
    <title>Quick Supabase Test</title>
    <style>
        body { font-family: Arial; margin: 20px; background: #f0f8ff; }
        .container { max-width: 600px; margin: 0 auto; background: white; padding: 30px; border-radius: 10px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .test-btn { background: #007bff; color: white; border: none; padding: 15px 30px; border-radius: 8px; cursor: pointer; margin: 10px; font-size: 16px; }
        .test-btn:hover { background: #0056b3; }
        .result { margin: 15px 0; padding: 15px; border-radius: 8px; }
        .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
    </style>
    <script src="js/universal-topbar-injector.js"></script>
</head>
<body>
    <div class="container">
        <h1>ðŸš€ Quick Supabase Upload Test</h1>
        <p>Test Supabase connection and upload functionality quickly</p>
        
        <button class="test-btn" onclick="testAPI()">Test API Connection</button>
        <button class="test-btn" onclick="testUpload()">Test Quick Upload</button>
        
        <div id="results"></div>
        
        <hr style="margin: 30px 0;">
        
        <h3>Quick Upload Test</h3>
        <input type="file" id="testFile" accept="image/*" style="margin: 10px 0;">
        <button class="test-btn" onclick="quickUpload()">Quick Upload to Supabase</button>
    </div>

    <script>
        function addResult(message, type = 'info') {
            const results = document.getElementById('results');
            const div = document.createElement('div');
            div.className = `result ${type}`;
            div.innerHTML = `<strong>${new Date().toLocaleTimeString()}</strong> - ${message}`;
            results.appendChild(div);
            results.scrollTop = results.scrollHeight;
        }

        async function testAPI() {
            addResult('Testing API connection...', 'info');
            
            try {
                const response = await fetch('/api/ideology/photos/management');
                
                if (response.ok) {
                    const data = await response.json();
                    addResult(`âœ… API connected! Found ${data.photos ? data.photos.length : 0} photos`, 'success');
                } else {
                    addResult(`âš ï¸ API responded with status: ${response.status}`, 'error');
                }
            } catch (error) {
                addResult(`âŒ API connection failed: ${error.message}`, 'error');
            }
        }

        async function testUpload() {
            addResult('Testing upload endpoint...', 'info');
            
            try {
                // Create a small test blob
                const canvas = document.createElement('canvas');
                canvas.width = 100;
                canvas.height = 100;
                const ctx = canvas.getContext('2d');
                ctx.fillStyle = '#ff0000';
                ctx.fillRect(0, 0, 100, 100);
                
                canvas.toBlob(async (blob) => {
                    const formData = new FormData();
                    formData.append('photos', blob, 'test.png');
                    formData.append('ideology_category', 'neutral');
                    formData.append('person_number', '1');
                    formData.append('developer_id', '1');
                    
                    const startTime = Date.now();
                    
                    try {
                        const response = await fetch('/api/ideology/photos/upload', {
                            method: 'POST',
                            body: formData
                        });
                        
                        const duration = Date.now() - startTime;
                        
                        if (response.ok) {
                            const result = await response.json();
                            addResult(`âœ… Upload successful in ${duration}ms! Photo ID: ${result.photos[0].id}`, 'success');
                        } else {
                            const error = await response.text();
                            addResult(`âŒ Upload failed (${response.status}): ${error}`, 'error');
                        }
                    } catch (error) {
                        const duration = Date.now() - startTime;
                        addResult(`âŒ Upload error after ${duration}ms: ${error.message}`, 'error');
                    }
                }, 'image/png');
                
            } catch (error) {
                addResult(`âŒ Test setup failed: ${error.message}`, 'error');
            }
        }

        async function quickUpload() {
            const fileInput = document.getElementById('testFile');
            const file = fileInput.files[0];
            
            if (!file) {
                addResult('âŒ Please select a file first!', 'error');
                return;
            }

            addResult(`ðŸ“¤ Uploading ${file.name} (${(file.size/1024).toFixed(1)}KB)...`, 'info');
            
            const formData = new FormData();
            formData.append('photos', file);
            formData.append('ideology_category', 'neutral');
            formData.append('person_number', '1');
            formData.append('developer_id', '1');
            
            const startTime = Date.now();
            
            try {
                // 8-second timeout
                const controller = new AbortController();
                const timeoutId = setTimeout(() => {
                    controller.abort();
                    addResult('â° Upload timeout after 8 seconds', 'error');
                }, 8000);
                
                const response = await fetch('/api/ideology/photos/upload', {
                    method: 'POST',
                    body: formData,
                    signal: controller.signal
                });
                
                clearTimeout(timeoutId);
                const duration = Date.now() - startTime;
                
                if (response.ok) {
                    const result = await response.json();
                    addResult(`ðŸŽ‰ SUCCESS! Upload completed in ${duration}ms`, 'success');
                    addResult(`ðŸ“Š Photo saved with ID: ${result.photos[0].id}`, 'info');
                    addResult(`ðŸ”— URL: ${result.photos[0].storage_url}`, 'info');
                } else {
                    const error = await response.text();
                    addResult(`âŒ Upload failed after ${duration}ms (${response.status}): ${error}`, 'error');
                }
                
            } catch (error) {
                const duration = Date.now() - startTime;
                if (error.name === 'AbortError') {
                    addResult(`â° Upload aborted after ${duration}ms (timeout)`, 'error');
                } else {
                    addResult(`âŒ Upload error after ${duration}ms: ${error.message}`, 'error');
                }
            }
        }

        // Auto-test on load
        window.addEventListener('load', () => {
            addResult('ðŸš€ Quick Supabase test page loaded', 'info');
            setTimeout(() => {
                testAPI();
            }, 1000);
        });
    </script>
</body>
</html>