<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live Debug - View Count Testing</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #1a2a6c, #b21f1f, #1a2a6c);
            color: white;
            min-height: 100vh;
        }
        
        .debug-container {
            background: rgba(0, 0, 0, 0.7);
            border-radius: 15px;
            padding: 25px;
            margin: 20px 0;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .status-card {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 20px;
            margin: 15px 0;
            border-left: 4px solid #4CAF50;
        }
        
        .error-card {
            border-left-color: #f44336;
        }
        
        .warning-card {
            border-left-color: #FFC107;
        }
        
        .test-button {
            background: linear-gradient(45deg, #2196F3, #21CBF3);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 30px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px;
            transition: all 0.3s ease;
            font-weight: 600;
        }
        
        .test-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(33, 150, 243, 0.4);
        }
        
        .test-button.error {
            background: linear-gradient(45deg, #f44336, #ff6b6b);
        }
        
        .test-button.warning {
            background: linear-gradient(45deg, #FFC107, #FFD54F);
            color: #333;
        }
        
        .console-output {
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 15px;
            border-radius: 8px;
            font-family: 'Consolas', 'Courier New', monospace;
            font-size: 14px;
            height: 300px;
            overflow-y: auto;
            margin: 15px 0;
            border: 1px solid #333;
        }
        
        .view-count-display {
            font-size: 24px;
            font-weight: bold;
            color: #4CAF50;
            text-align: center;
            padding: 20px;
            background: rgba(76, 175, 80, 0.2);
            border-radius: 10px;
            margin: 15px 0;
        }
        
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: #4CAF50;
            animation: spin 1s ease-in-out infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        
        .indicator.ok { background: #4CAF50; }
        .indicator.warning { background: #FFC107; }
        .indicator.error { background: #f44336; }
        .indicator.loading { background: #2196F3; }
    </style>
    <script src="/config.js"></script>
</head>
<body>
    <h1>üî¨ Live View Count Debug</h1>
    <p>Real-time testing and debugging of view tracking functionality</p>
    
    <div class="debug-container">
        <h2>üìä System Status</h2>
        <div id="systemStatus">
            <div class="status-card">
                <span class="indicator loading"></span>
                <strong>Initializing system check...</strong>
            </div>
        </div>
    </div>
    
    <div class="debug-container">
        <h2>üéØ View Count Testing</h2>
        <div class="view-count-display">
            Current Test Views: <span id="viewCount">0</span>
            <div style="font-size: 14px; color: #aaa; margin-top: 5px;">
                (This will update in real-time)
            </div>
        </div>
        
        <div style="text-align: center;">
            <button class="test-button" onclick="testSingleView()">üìà Track Single View</button>
            <button class="test-button warning" onclick="testBatchViews()">üìä Track 5 Views</button>
            <button class="test-button error" onclick="resetTest()">üîÑ Reset Test</button>
        </div>
    </div>
    
    <div class="debug-container">
        <h2>üìã Real-time Console</h2>
        <div class="console-output" id="consoleOutput">
            > Live debugging session started<br>
            > Waiting for system initialization...<br>
        </div>
        <div style="text-align: center; margin-top: 10px;">
            <button class="test-button" onclick="clearConsole()">Clear Console</button>
        </div>
    </div>
    
    <div class="debug-container">
        <h2>üîß Manual Testing</h2>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
            <div>
                <h3>Storage Test</h3>
                <button class="test-button" onclick="testStorage()">Test Storage</button>
                <div id="storageResult"></div>
            </div>
            <div>
                <h3>Network Test</h3>
                <button class="test-button" onclick="testNetwork()">Test Network</button>
                <div id="networkResult"></div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <!-- Enhanced Storage and Loading Fix -->
    <script src="storage-fix.js"></script>
    
    <!-- Audio Context Fix -->
    <script src="audio-fix.js"></script>
    
    <!-- Enhanced Image Loader -->
    <script src="image-loader.js"></script>
    
    <!-- Fixed View Tracker -->
    <script src="js/view-tracker-fixed.js"></script>
    
    <script>
        // Test data
        let testViewCount = 0;
        const testPostId = 'live-debug-' + Date.now();
        
        // Console output element
        const consoleOutput = document.getElementById('consoleOutput');
        const viewCountEl = document.getElementById('viewCount');
        
        // Log to console display
        function logToConsole(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const typeColor = {
                'info': '#4CAF50',
                'warning': '#FFC107',
                'error': '#f44336',
                'network': '#2196F3'
            };
            
            const logEntry = document.createElement('div');
            logEntry.innerHTML = `<span style="color: ${typeColor[type] || '#d4d4d4'}">[${timestamp}] ${message}</span>`;
            consoleOutput.appendChild(logEntry);
            consoleOutput.scrollTop = consoleOutput.scrollHeight;
            
            // Also log to actual console
            console.log(`[Debug] ${message}`);
        }
        
        // Clear console
        function clearConsole() {
            consoleOutput.innerHTML = '> Console cleared<br>';
        }
        
        // Update system status
        function updateStatus(title, message, status = 'ok') {
            const statusContainer = document.getElementById('systemStatus');
            const statusCard = document.createElement('div');
            statusCard.className = `status-card ${status === 'error' ? 'error-card' : status === 'warning' ? 'warning-card' : ''}`;
            statusCard.innerHTML = `
                <span class="indicator ${status}"></span>
                <strong>${title}:</strong> ${message}
            `;
            statusContainer.appendChild(statusCard);
        }
        
        // Test single view tracking
        async function testSingleView() {
            logToConsole('Testing single view tracking...', 'info');
            
            try {
                if (window.ViewTracker) {
                    const result = await window.ViewTracker.trackView(testPostId, 'post');
                    testViewCount++;
                    viewCountEl.textContent = testViewCount;
                    
                    logToConsole(`‚úÖ View tracked successfully: ${JSON.stringify(result)}`, 'info');
                    logToConsole(`üìä Total test views: ${testViewCount}`, 'info');
                } else {
                    logToConsole('‚ùå ViewTracker not available', 'error');
                    updateStatus('View Tracking', 'ViewTracker not initialized', 'error');
                }
            } catch (error) {
                logToConsole(`‚ùå Error tracking view: ${error.message}`, 'error');
                updateStatus('View Tracking', `Error: ${error.message}`, 'error');
            }
        }
        
        // Test batch view tracking
        async function testBatchViews() {
            logToConsole('Testing batch view tracking (5 views)...', 'info');
            
            for (let i = 0; i < 5; i++) {
                await new Promise(resolve => setTimeout(resolve, 300)); // Small delay
                await testSingleView();
            }
        }
        
        // Reset test
        function resetTest() {
            testViewCount = 0;
            viewCountEl.textContent = '0';
            logToConsole('üîÑ Test reset to zero', 'info');
        }
        
        // Test storage functionality
        async function testStorage() {
            const resultEl = document.getElementById('storageResult');
            resultEl.innerHTML = '<div class="loading"></div> Testing...';
            
            try {
                const testKey = 'debug_test_' + Date.now();
                localStorage.setItem(testKey, 'test_value');
                const value = localStorage.getItem(testKey);
                localStorage.removeItem(testKey);
                
                if (value === 'test_value') {
                    resultEl.innerHTML = '<span style="color: #4CAF50;">‚úÖ Storage working</span>';
                    logToConsole('‚úÖ Storage test passed', 'info');
                } else {
                    resultEl.innerHTML = '<span style="color: #FFC107;">‚ö†Ô∏è Storage fallback active</span>';
                    logToConsole('‚ö†Ô∏è Storage using fallback', 'warning');
                }
            } catch (error) {
                resultEl.innerHTML = '<span style="color: #f44336;">‚ùå Storage blocked</span>';
                logToConsole(`‚ùå Storage error: ${error.message}`, 'error');
            }
        }
        
        // Test network connectivity
        async function testNetwork() {
            const resultEl = document.getElementById('networkResult');
            resultEl.innerHTML = '<div class="loading"></div> Testing...';
            
            try {
                const response = await fetch('https://httpbin.org/get?test=network');
                if (response.ok) {
                    resultEl.innerHTML = '<span style="color: #4CAF50;">‚úÖ Network OK</span>';
                    logToConsole('‚úÖ Network connectivity test passed', 'network');
                } else {
                    resultEl.innerHTML = '<span style="color: #FFC107;">‚ö†Ô∏è Network issues</span>';
                    logToConsole(`‚ö†Ô∏è Network response: ${response.status}`, 'warning');
                }
            } catch (error) {
                resultEl.innerHTML = '<span style="color: #f44336;">‚ùå Network failed</span>';
                logToConsole(`‚ùå Network error: ${error.message}`, 'error');
            }
        }
        
        // Initialize debugging
        window.addEventListener('DOMContentLoaded', async () => {
            logToConsole('üîç Live debug session started', 'info');
            
            // Check for ViewTracker and initialize if needed
            setTimeout(() => {
                if (window.ViewTracker) {
                    updateStatus('View Tracking', 'ViewTracker loaded and ready', 'ok');
                    logToConsole('‚úÖ ViewTracker detected and initialized', 'info');
                } else {
                    updateStatus('View Tracking', 'ViewTracker not found - attempting manual load', 'warning');
                    logToConsole('‚ö†Ô∏è ViewTracker not detected, trying manual initialization', 'warning');
                    
                    // Try to load manually
                    if (typeof ViewTrackerFixed !== 'undefined') {
                        window.ViewTracker = new ViewTrackerFixed();
                        window.ViewTracker.initPageTracking();
                        updateStatus('View Tracking', 'Manually initialized', 'ok');
                        logToConsole('‚úÖ ViewTracker manually initialized', 'info');
                    } else {
                        // Create minimal fallback tracker
                        window.ViewTracker = {
                            trackedContent: new Set(),
                            trackView: async function(contentId, contentType) {
                                try {
                                    // Simple Supabase update for testing
                                    const response = await fetch(`https://gkckyyyaoqsaouemjnxl.supabase.co/rest/v1/${contentType === 'post' ? 'posts' : 'articles'}?id=eq.${contentId}`, {
                                        method: 'PATCH',
                                        headers: {
                                            'apikey': window.APP_CONFIG?.supabaseAnonKey || '',
                                            'Authorization': `Bearer ${window.APP_CONFIG?.supabaseAnonKey || ''}`,
                                            'Content-Type': 'application/json',
                                            'Prefer': 'return=representation'
                                        },
                                        body: JSON.stringify({
                                            views_count: supabaseClient.sql`views_count + 1`
                                        })
                                    });
                                    
                                    if (response.ok) {
                                        const data = await response.json();
                                        const newCount = data && data[0] ? data[0].views_count : testViewCount + 1;
                                        return {
                                            view_counts: {
                                                total_views: newCount,
                                                unique_views: newCount,
                                                recently_viewed: true
                                            }
                                        };
                                    }
                                } catch (error) {
                                    // Fallback to mock data
                                    return {
                                        view_counts: {
                                            total_views: testViewCount + 1,
                                            unique_views: testViewCount + 1,
                                            recently_viewed: true
                                        }
                                    };
                                }
                            },
                            updateViewDisplay: function(contentId, contentType, viewCounts) {
                                // Update local display
                                testViewCount = viewCounts.total_views;
                                viewCountEl.textContent = testViewCount;
                            }
                        };
                        
                        updateStatus('View Tracking', 'Fallback tracker created', 'warning');
                        logToConsole('üîß Fallback ViewTracker created', 'warning');
                    }
                }
            }, 1000);
            
            // Test storage automatically
            setTimeout(testStorage, 1500);
            
            // Test network automatically
            setTimeout(testNetwork, 2000);
            
            // Periodic status update
            setInterval(() => {
                if (window.ViewTracker) {
                    const trackedCount = window.ViewTracker.trackedContent?.size || 0;
                    logToConsole(`üìà Currently tracking ${trackedCount} items`, 'info');
                }
            }, 15000);
        });
        
        // Capture console logs
        const originalConsoleLog = console.log;
        console.log = function() {
            const args = Array.from(arguments);
            const message = args.join(' ');
            if (message.includes('View tracked') || message.includes('Error tracking')) {
                logToConsole(message, message.includes('Error') ? 'error' : 'info');
            }
            originalConsoleLog.apply(console, arguments);
        };
        
        const originalConsoleError = console.error;
        console.error = function() {
            const args = Array.from(arguments);
            const message = args.join(' ');
            logToConsole(`‚ùå ${message}`, 'error');
            originalConsoleError.apply(console, arguments);
        };
    </script>
</body>
</html>