<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Messages - IAMCALLING</title>
    
    <script src="https://unpkg.com/@supabase/supabase-js@2" onerror="console.log('Supabase CDN failed, will retry')"></script>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" onerror="this.remove()">
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap');

        :root {
            --background: #0b141a;
            --primary: #00a884;
            --primary-dark: #06cf9c;
            --text-dark: #e9edef;
            --text-light: #8696a0;
            --border-color: #2a3942;
            --message-bg: #202c33;
            --message-sent-bg: #005c4b;
            --white: #ffffff;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Roboto', sans-serif;
            background-color: var(--background);
            color: var(--text-dark);
            height: 100vh;
            overflow: hidden;
        }

        .universal-topbar {
            display: none !important;
        }

        .app-container {
            display: flex;
            height: 100vh;
            width: 100%;
            position: relative;
        }

        .view {
            width: 100%;
            height: 100%;
            position: absolute;
            top: 0;
            left: 0;
            background-color: #111b21;
            transition: transform 0.3s ease-in-out;
            display: flex;
            flex-direction: column;
            overflow: hidden !important;
        }

        #chat-list-view {
            transform: translateX(0);
        }

        #chat-window-view {
            transform: translateX(100%);
        }

        #chat-window-view.active {
            transform: translateX(0);
            visibility: visible;
        }

        .chat-list-header {
            padding: 15px !important;
            border-bottom: 1px solid var(--border-color) !important;
            background-color: #202c33 !important;
            flex-shrink: 0 !important;
            min-height: 90px !important;
            height: 90px !important;
            display: flex !important;
            flex-direction: row !important;
            align-items: center !important;
            justify-content: space-between !important;
            gap: 10px !important;
            position: absolute !important;
            top: 0 !important;
            left: 0 !important;
            right: 0 !important;
            z-index: 1000 !important;
            width: 100% !important;
            color: #ffffff !important;
        }

        .header-left {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .current-user-profile {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
        }

        .current-user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: 2px solid var(--primary);
            object-fit: cover;
        }

        .current-user-name {
            font-size: 14px;
            font-weight: 500;
            color: var(--primary);
        }

        .chat-list-header h2 {
            color: #ffffff !important;
            font-size: 22px !important;
            margin: 0 0 10px 0 !important;
            font-weight: 600 !important;
            display: block !important;
            visibility: visible !important;
            opacity: 1 !important;
            line-height: 1.5 !important;
            height: auto !important;
        }

        .search-box {
            background: #2a3942 !important;
            border: none !important;
            border-radius: 8px !important;
            padding: 10px 12px !important;
            color: #ffffff !important;
            width: 100% !important;
            font-size: 14px !important;
            display: block !important;
            visibility: visible !important;
            opacity: 1 !important;
            height: 40px !important;
        }

        .search-box::placeholder {
            color: #8696a0 !important;
        }

        .search-box:focus {
            outline: none;
            background: #3b4a54;
        }

        .chat-list, #conversationsList {
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
            -webkit-overflow-scrolling: touch;
            padding-top: 100px !important;
            position: relative !important;
            top: 0 !important;
        }

        .conversation-item {
            display: flex;
            align-items: center;
            padding: 12px 15px;
            cursor: pointer;
            transition: background-color 0.2s;
            gap: 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .conversation-item:hover {
            background-color: rgba(255, 255, 255, 0.05);
        }

        .conversation-item.active {
            background-color: #2a3942;
        }

        .user-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            flex-shrink: 0;
            position: relative;
        }

        .user-avatar img {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            object-fit: cover;
        }

        .user-status {
            position: absolute;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            bottom: 0;
            right: 0;
            border: 2px solid #111b21;
            background: #8696a0;
        }

        .user-status.online {
            background: var(--primary);
        }

        .conversation-info {
            flex-grow: 1;
            min-width: 0;
        }

        .conversation-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 4px;
        }

        .user-name {
            font-weight: 500;
            font-size: 16px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .last-message {
            color: var(--text-light);
            font-size: 14px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .meta-column {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 5px;
        }

        .message-time {
            font-size: 12px;
            color: var(--text-light);
        }

        .unread-badge {
            background-color: var(--primary);
            color: white;
            border-radius: 10px;
            padding: 2px 6px;
            font-size: 11px;
            font-weight: bold;
            min-width: 18px;
            text-align: center;
        }

        .chat-window-header {
            display: flex !important;
            align-items: center !important;
            padding: 15px !important;
            background: #202c33 !important;
            border-bottom: 1px solid var(--border-color) !important;
            gap: 12px !important;
            flex-shrink: 0 !important;
            min-height: 70px !important;
            max-height: 70px !important;
            height: 70px !important;
            position: relative !important;
            z-index: 100 !important;
            width: 100% !important;
        }

        .back-btn {
            background: none;
            border: none;
            font-size: 24px !important;
            cursor: pointer;
            color: #ffffff !important;
            padding: 5px;
            display: block !important;
            flex-shrink: 0 !important;
        }

        .chat-avatar {
            width: 45px !important;
            height: 45px !important;
            border-radius: 50% !important;
            object-fit: cover !important;
            border: 2px solid var(--primary) !important;
            flex-shrink: 0 !important;
        }

        .chat-window-info {
            flex: 1 !important;
        }

        .chat-window-info h3 {
            font-size: 18px !important;
            font-weight: 600 !important;
            color: #ffffff !important;
            margin: 0 !important;
        }

        .chat-window-info p {
            color: #8696a0 !important;
            font-size: 13px !important;
            margin: 2px 0 0 0 !important;
        }

        .chat-messages {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            overflow-x: hidden;
            display: flex;
            flex-direction: column;
            gap: 8px;
            background: var(--background);
            -webkit-overflow-scrolling: touch;
        }

        .message {
            max-width: 75%;
            display: flex;
            flex-direction: column;
        }

        .message.sent {
            align-self: flex-end;
        }

        .message.received {
            align-self: flex-start;
        }

        .message-bubble {
            padding: 8px 12px;
            border-radius: 8px;
            line-height: 1.4;
            word-wrap: break-word;
            font-size: 15px;
        }

        .message.sent .message-bubble {
            background-color: var(--message-sent-bg) !important;
            color: var(--white) !important;
            border-bottom-right-radius: 2px;
        }

        .message.received .message-bubble {
            background-color: var(--message-bg) !important;
            color: var(--text-dark) !important;
            border-bottom-left-radius: 2px;
        }

        .message-meta {
            display: flex;
            align-items: center;
            justify-content: flex-end;
            gap: 4px;
            margin-top: 4px;
        }

        .message-meta .message-time {
            font-size: 11px;
            color: rgba(233, 237, 239, 0.6);
        }

        .chat-input-area {
            padding: 15px;
            background-color: #202c33;
            border-top: 1px solid var(--border-color);
            flex-shrink: 0;
        }

        #message-form {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        #chat-input {
            flex-grow: 1;
            background-color: #2a3942;
            border: none;
            border-radius: 20px;
            padding: 12px 15px;
            font-size: 16px;
            outline: none;
            color: var(--text-dark);
        }

        #send-btn {
            background-color: var(--primary);
            color: var(--white);
            border: none;
            border-radius: 50%;
            width: 45px;
            height: 45px;
            cursor: pointer;
            font-size: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.2s;
        }

        #send-btn:hover {
            background-color: var(--primary-dark);
        }

        @media (min-width: 768px) {
            .app-container {
                max-width: 1200px;
                margin: 0 auto;
            }

            .view {
                position: static;
                transform: none !important;
                transition: none;
            }

            #chat-list-view {
                width: 400px;
                border-right: 1px solid var(--border-color);
            }

            #chat-window-view {
                flex-grow: 1;
                visibility: visible !important;
                display: flex !important;
            }

            .back-btn {
                display: none !important;
            }
            
            .chat-window-header {
                display: flex !important;
                visibility: visible !important;
                opacity: 1 !important;
            }
            
            .chat-list-header {
                display: flex !important;
                visibility: visible !important;
                opacity: 1 !important;
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Chat List View -->
        <div class="view" id="chat-list-view">
            <header class="chat-list-header">
                <div class="header-left">
                    <h2>Messages</h2>
                    <input type="text" class="search-box" placeholder="Search conversations..." id="searchBox">
                </div>
                <div class="current-user-profile" id="currentUserProfile">
                    <img src="" alt="You" class="current-user-avatar" id="currentUserAvatar">
                    <span class="current-user-name" id="currentUserName">You</span>
                </div>
            </header>
            <div class="chat-list" id="conversationsList">
                <!-- Users load here -->
            </div>
        </div>

        <!-- Chat Window View -->
        <div class="view" id="chat-window-view">
            <header class="chat-window-header" id="chatWindowHeader">
                <button class="back-btn" id="back-btn">‚Üê</button>
                <img src="https://ui-avatars.com/api/?name=User&background=00a884&color=fff&size=50" alt="avatar" class="chat-avatar" id="chatUserAvatarImg">
                <div class="chat-window-info">
                    <h3 id="chatUserName">Select a chat</h3>
                    <p id="chatUserStatus">Tap on a conversation</p>
                </div>
            </header>

            <main class="chat-messages" id="chat-messages">
                <!-- Messages will be added here -->
            </main>

            <footer class="chat-input-area">
                <form id="message-form">
                    <input type="text" id="chat-input" placeholder="Type a message" autocomplete="off">
                    <button type="submit" id="send-btn">‚û§</button>
                </form>
            </footer>
        </div>
    </div>

    <script>

        // Back button handler
        document.getElementById('back-btn').addEventListener('click', function() {
            document.getElementById('chat-window-view').classList.remove('active');
        });

        // Update selectUser to show chat window
        window.selectUser = function(userId, userName, avatar) {
            console.log('üéØ selectUser called:', userId, userName);
            
            currentChatUser = { id: userId, name: userName, avatar: avatar };
            
            // Update active state
            document.querySelectorAll('.conversation-item').forEach(item => {
                item.classList.remove('active');
            });
            const selectedItem = document.querySelector(`[data-user-id="${userId}"]`);
            if (selectedItem) selectedItem.classList.add('active');
            
            // Show chat window FIRST
            const chatWindow = document.getElementById('chat-window-view');
            chatWindow.classList.add('active');
            
            // Update header - show elements and set content
            const nameEl = document.getElementById('chatUserName');
            const statusEl = document.getElementById('chatUserStatus');
            const avatarEl = document.getElementById('chatUserAvatarImg');
            
            if (avatarEl) {
                avatarEl.src = avatar;
                avatarEl.style.display = 'block';
            }
            if (nameEl) {
                nameEl.textContent = userName;
                nameEl.style.display = 'block';
            }
            if (statusEl) {
                statusEl.textContent = 'Online';
                statusEl.style.display = 'flex';
            }
            
            console.log('‚úÖ Header updated:', userName);
            
            // Enable input
            const input = document.getElementById('chat-input');
            const sendBtn = document.getElementById('send-btn');
            if (input) input.disabled = false;
            if (sendBtn) sendBtn.disabled = false;
            
            clearUnreadCount(userId);
            loadMessages(userId, userName);
            
            setTimeout(() => { if (input) input.focus(); }, 100);
        };



        // Message storage and real-time
        let currentChatUser = null;
        let messages = {}; // Store messages by userId
        let unreadCounts = {}; // Track unread messages
        let conversationOrder = []; // Track conversation order
        
        // Real-time messaging setup - Load from server config
        let SUPABASE_URL = 'https://gkckyyyaoqsaouemjnxl.supabase.co';
        let SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdrY2t5eXlhb3FzYW91ZW1qbnhsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTcyMzA3OTEsImV4cCI6MjA3MjgwNjc5MX0.0z5c-3P1fMSW2qiWg7IT3Oqv-65B3lZ8Lsq2aDvMYQk';
        
        // Load config from server (non-blocking)
        fetch('/config.js')
            .then(res => res.text())
            .then(configScript => {
                eval(configScript);
                if (window.APP_CONFIG?.supabaseUrl) {
                    SUPABASE_URL = window.APP_CONFIG.supabaseUrl;
                    SUPABASE_ANON_KEY = window.APP_CONFIG.supabaseAnonKey;
                    console.log('‚úÖ Updated Supabase config from server');
                }
                initializeMessaging();
            })
            .catch(err => {
                console.log('‚ö†Ô∏è Using default config');
                initializeMessaging();
            });
        
        // Safe storage access with fallback
        let memoryStorage = {};
        
        function safeGetStorage(key, defaultValue = '{}') {
            try {
                return localStorage.getItem(key) || defaultValue;
            } catch (e) {
                try {
                    return sessionStorage.getItem(key) || defaultValue;
                } catch (e2) {
                    return memoryStorage[key] || defaultValue;
                }
            }
        }
        
        function safeSetStorage(key, value) {
            try {
                localStorage.setItem(key, value);
            } catch (e) {
                try {
                    sessionStorage.setItem(key, value);
                } catch (e2) {
                    memoryStorage[key] = value;
                }
            }
        }
        
        let currentUser = {};
        try {
            currentUser = JSON.parse(safeGetStorage('currentUser', '{}'));
        } catch (e) {
            console.log('‚ö†Ô∏è Storage access blocked, using defaults');
            currentUser = {};
        }
        const currentUserId = currentUser.id || 157;
        
        let supabaseClient = null;
        let realtimeChannel = null;
        
        // Auto-setup messaging database and enable real-time
        async function initializeMessaging() {
            try {
                // Load Supabase client
                if (typeof supabase !== 'undefined') {
                    supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                    console.log('‚úÖ Supabase client initialized');
                    
                    // Setup realtime subscription
                    setupRealtimeSubscription();
                } else {
                    console.log('‚ö†Ô∏è Supabase library not loaded, loading now...');
                    // Load Supabase library
                    const script = document.createElement('script');
                    script.src = 'https://unpkg.com/@supabase/supabase-js@2';
                    script.onload = () => {
                        supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                        console.log('‚úÖ Supabase client initialized after loading');
                        setupRealtimeSubscription();
                    };
                    document.head.appendChild(script);
                }
            } catch (error) {
                console.log('‚ùå Database initialization failed:', error);
            }
        }
        
        // Setup realtime subscription with retry logic
        let realtimeRetryCount = 0;
        const MAX_RETRY = 3;
        let realtimeRetryTimeout = null;
        
        function setupRealtimeSubscription() {
            if (!supabaseClient) {
                console.log('‚ö†Ô∏è Supabase client not ready, will retry');
                return;
            }
            
            console.log('üîî Setting up realtime subscription for user:', currentUserId);
            
            try {
                // Subscribe to messages where current user is the receiver
                realtimeChannel = supabaseClient
                    .channel('messages')
                    .on(
                        'postgres_changes',
                        {
                            event: 'INSERT',
                            schema: 'public',
                            table: 'messages',
                            filter: `receiver_id=eq.${currentUserId}`
                        },
                        (payload) => {
                            console.log('üì® New message received:', payload);
                            handleIncomingMessage(payload.new);
                        }
                    )
                    .subscribe((status) => {
                        console.log('Realtime subscription status:', status);
                        
                        if (status === 'CHANNEL_ERROR' || status === 'TIMED_OUT' || status === 'CLOSED') {
                            if (realtimeRetryCount < MAX_RETRY) {
                                realtimeRetryCount++;
                                console.log(`‚ö†Ô∏è Realtime failed, retry ${realtimeRetryCount}/${MAX_RETRY} in 5s`);
                                
                                clearTimeout(realtimeRetryTimeout);
                                realtimeRetryTimeout = setTimeout(() => {
                                    if (realtimeChannel) {
                                        realtimeChannel.unsubscribe();
                                    }
                                    setupRealtimeSubscription();
                                }, 5000);
                            } else {
                                console.log('‚ùå Realtime failed after max retries, using polling fallback');
                                startPollingFallback();
                            }
                        } else if (status === 'SUBSCRIBED') {
                            console.log('‚úÖ Realtime connected successfully');
                            realtimeRetryCount = 0;
                            stopPollingFallback();
                        }
                    });
            } catch (error) {
                console.log('‚ùå Realtime setup error:', error);
                startPollingFallback();
            }
        }
        
        // Polling fallback when WebSocket fails
        let pollingInterval = null;
        let lastPollTime = Date.now();
        
        function startPollingFallback() {
            if (pollingInterval) return;
            console.log('üîÑ Starting polling fallback (every 5s)');
            
            pollingInterval = setInterval(async () => {
                if (!currentChatUser) return;
                
                try {
                    const response = await fetch(`${SUPABASE_URL}/rest/v1/messages?receiver_id=eq.${currentUserId}&sender_id=eq.${currentChatUser.id}&created_at=gt.${new Date(lastPollTime).toISOString()}&order=created_at.asc`, {
                        headers: {
                            'apikey': SUPABASE_ANON_KEY,
                            'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                            'Accept': 'application/json'
                        }
                    });
                    
                    if (response.ok) {
                        const newMessages = await response.json();
                        newMessages.forEach(msg => handleIncomingMessage(msg));
                        lastPollTime = Date.now();
                    }
                } catch (error) {
                    console.log('‚ö†Ô∏è Polling error:', error);
                }
            }, 2000);
        }
        
        function stopPollingFallback() {
            if (pollingInterval) {
                clearInterval(pollingInterval);
                pollingInterval = null;
                console.log('‚úÖ Stopped polling fallback');
            }
        }
        
        // Config will be loaded and initializeMessaging() will be called automatically
        
        // Display current user profile
        (function displayCurrentUser() {
            const avatar = document.getElementById('currentUserAvatar');
            const name = document.getElementById('currentUserName');
            const profile = document.getElementById('currentUserProfile');
            
            const firstName = currentUser.first_name || '';
            const lastName = currentUser.last_name || '';
            const userName = `${firstName} ${lastName}`.trim() || 'You';
            const userAvatar = currentUser.profile_photo || `https://ui-avatars.com/api/?name=${encodeURIComponent(userName)}&background=00a884&color=fff&size=50`;
            
            if (avatar) avatar.src = userAvatar;
            if (name) name.textContent = userName;
            if (profile) profile.onclick = () => window.location.href = '18-profile.html';
        })();
        


        
        // Load messages for a user
        async function loadMessages(userId, userName) {
            const chatMessages = document.getElementById('chat-messages');
            
            try {
                // Get messages between current user and selected user
                const response = await fetch(`${SUPABASE_URL}/rest/v1/messages?or=(and(sender_id.eq.${currentUserId},receiver_id.eq.${userId}),and(sender_id.eq.${userId},receiver_id.eq.${currentUserId}))&order=created_at.asc`, {
                    headers: {
                        'apikey': SUPABASE_ANON_KEY,
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                        'Accept': 'application/json'
                    }
                });
                
                if (response.ok) {
                    const dbMessages = await response.json();
                    
                    if (dbMessages.length > 0) {
                        // Convert DB messages to display format
                        const displayMessages = dbMessages.map(msg => ({
                            id: msg.id,
                            text: msg.content,
                            time: new Date(msg.created_at).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}),
                            type: msg.sender_id === currentUserId ? 'sent' : 'received',
                            timestamp: new Date(msg.created_at).getTime()
                        }));
                        
                        // Store in local cache
                        messages[userId] = displayMessages;
                        
                        // Display messages
                        chatMessages.innerHTML = displayMessages.map(msg => `
                            <div class="message ${msg.type}">
                                <div class="message-bubble" ${msg.type === 'sent' ? 'style="background: #128c7e !important;"' : ''}>
                                    ${msg.text}
                                    <div class="message-meta">
                                        <span class="message-time">${msg.time}</span>
                                        ${msg.type === 'sent' ? '<i class="fas fa-check-double message-status delivered"></i>' : ''}
                                    </div>
                                </div>
                            </div>
                        `).join('');
                        
                        // Mark all received messages as read when opening chat
                        markMessagesAsRead(userId, dbMessages);
                        
                    } else {
                        // No messages, show welcome
                        chatMessages.innerHTML = `
                            <div class="message system" style="align-self: center; max-width: 80%; margin: 20px auto;">
                                <div class="message-bubble" style="background: #202c33; text-align: center; border-radius: 8px;">
                                    You are now chatting with ${userName}. Say hello!
                                    <div class="message-meta">
                                        <span class="message-time">Just now</span>
                                    </div>
                                </div>
                            </div>
                        `;
                    }
                } else {
                    throw new Error('Failed to load messages');
                }
            } catch (error) {
                console.log('Error loading messages:', error);
                // Show welcome message on error
                chatMessages.innerHTML = `
                    <div class="message system" style="align-self: center; max-width: 80%; margin: 20px auto;">
                        <div class="message-bubble" style="background: #202c33; text-align: center; border-radius: 8px;">
                            You are now chatting with ${userName}. Say hello!
                            <div class="message-meta">
                                <span class="message-time">Just now</span>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            // Scroll to bottom
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }
        
        // Check if message is read
        function isMessageRead(messageId) {
            const readMessages = JSON.parse(safeGetStorage('readMessages', '[]'));
            return readMessages.includes(messageId);
        }
        
        // Mark single message as read
        function markMessageAsRead(messageId) {
            const readMessages = JSON.parse(safeGetStorage('readMessages', '[]'));
            if (!readMessages.includes(messageId)) {
                readMessages.push(messageId);
                safeSetStorage('readMessages', JSON.stringify(readMessages));
            }
        }
        
        // Mark messages as read
        function markMessagesAsRead(senderId, messages) {
            const readMessages = JSON.parse(safeGetStorage('readMessages', '[]'));
            const receivedMessages = messages.filter(msg => msg.sender_id === senderId && msg.receiver_id === currentUserId);
            
            receivedMessages.forEach(msg => {
                if (!readMessages.includes(msg.id)) {
                    readMessages.push(msg.id);
                }
            });
            
            safeSetStorage('readMessages', JSON.stringify(readMessages));
            
            // Update unread count to 0 since we just read all messages
            unreadCounts[senderId] = 0;
            safeSetStorage(`unreadCount_${senderId}`, '0');
            updateConversationBadge(senderId, 0);
        }
        
        // Send message function
        function sendMessage() {
            if (!currentChatUser) return;
            
            const input = document.getElementById('chat-input');
            const messageText = input.value.trim();
            
            if (!messageText) return;
            
            const now = new Date();
            const timeStr = now.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            
            // Send to Supabase
            sendMessageToSupabase(currentChatUser.id, messageText, now);
            
            // Create message object
            const message = {
                text: messageText,
                time: timeStr,
                type: 'sent',
                timestamp: now.getTime()
            };
            
            // Store message locally
            if (!messages[currentChatUser.id]) {
                messages[currentChatUser.id] = [];
            }
            messages[currentChatUser.id].push(message);
            
            // Add to chat
            const chatMessages = document.getElementById('chat-messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message sent';
            messageDiv.innerHTML = `
                <div class="message-bubble" style="background: #128c7e !important;">
                    ${messageText}
                    <div class="message-meta">
                        <span class="message-time">${timeStr}</span>
                        <i class="fas fa-check-double message-status delivered"></i>
                    </div>
                </div>
            `;
            
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
            
            // Clear input
            input.value = '';
            input.style.height = 'auto';
            
            // Move conversation to top
            moveConversationToTop(currentChatUser.id, messageText, timeStr);
        }
        
        // Send message to Supabase
        async function sendMessageToSupabase(receiverId, messageText, timestamp) {
            try {
                const response = await fetch(`${SUPABASE_URL}/rest/v1/messages`, {
                    method: 'POST',
                    headers: {
                        'apikey': SUPABASE_ANON_KEY,
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        sender_id: currentUserId,
                        receiver_id: receiverId,
                        content: messageText
                    })
                });
                
                if (response.ok) {
                    console.log('‚úÖ Message saved successfully');
                } else {
                    console.log('‚ùå Failed to save message:', response.status);
                }
                
            } catch (error) {
                console.log('‚ùå Error sending message:', error);
            }
        }

        // Handle incoming message
        function handleIncomingMessage(msg) {
            const senderId = msg.sender_id;
            const messageText = msg.content;
            const timestamp = new Date(msg.created_at);
            const timeStr = timestamp.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            
            console.log(`üì® Incoming message from ${senderId}: ${messageText}`);
            
            // Check if message already processed
            if (isMessageRead(msg.id)) {
                console.log('‚ö†Ô∏è Message already processed, skipping');
                return;
            }
            
            // Store message
            if (!messages[senderId]) {
                messages[senderId] = [];
            }
            
            const message = {
                id: msg.id,
                text: messageText,
                time: timeStr,
                type: 'received',
                timestamp: timestamp.getTime()
            };
            
            messages[senderId].push(message);
            
            // Update unread count - only if not currently viewing this chat
            if (!currentChatUser || currentChatUser.id != senderId) {
                if (!unreadCounts[senderId]) unreadCounts[senderId] = 0;
                unreadCounts[senderId]++;
                
                // Store in storage for profile page sync
                safeSetStorage(`unreadCount_${senderId}`, unreadCounts[senderId].toString());
                
                console.log(`üîî Unread count for ${senderId}: ${unreadCounts[senderId]}`);
                
                // Update badge in conversation list
                updateConversationBadge(senderId, unreadCounts[senderId]);
            } else {
                // If currently viewing this chat, mark as read immediately and display
                markMessageAsRead(msg.id);
                
                // Add to chat in real-time
                const chatMessages = document.getElementById('chat-messages');
                const messageDiv = document.createElement('div');
                messageDiv.className = 'message received';
                messageDiv.innerHTML = `
                    <div class="message-bubble">
                        ${messageText}
                        <div class="message-meta">
                            <span class="message-time">${timeStr}</span>
                        </div>
                    </div>
                `;
                
                chatMessages.appendChild(messageDiv);
                chatMessages.scrollTop = chatMessages.scrollHeight;
                console.log('‚úÖ Message added to current chat in real-time');
            }
            
            // Move conversation to top and update preview
            moveConversationToTop(senderId, messageText, timeStr);
        }
        
        // Update conversation badge
        function updateConversationBadge(userId, count) {
            const conversationItem = document.querySelector(`[data-user-id="${userId}"]`);
            if (conversationItem) {
                let badge = conversationItem.querySelector('.unread-badge');
                if (!badge) {
                    badge = document.createElement('div');
                    badge.className = 'unread-badge';
                    const metaColumn = conversationItem.querySelector('.meta-column') || conversationItem.querySelector('.conversation-header');
                    if (metaColumn) {
                        metaColumn.appendChild(badge);
                    }
                }
                
                if (count > 0) {
                    badge.textContent = count > 99 ? '99+' : count.toString();
                    badge.style.display = 'flex';
                    conversationItem.classList.add('has-unread');
                } else {
                    badge.style.display = 'none';
                    conversationItem.classList.remove('has-unread');
                }
            }
        }
        

        // Move conversation to top
        function moveConversationToTop(userId, lastMessage, time) {
            const container = document.getElementById('conversationsList');
            const conversationItem = document.querySelector(`[data-user-id="${userId}"]`);
            
            if (conversationItem && container) {
                // Update preview
                const lastMessageEl = conversationItem.querySelector('.last-message');
                const timeEl = conversationItem.querySelector('.message-time');
                
                if (lastMessageEl) lastMessageEl.textContent = lastMessage;
                if (timeEl) timeEl.textContent = time;
                
                // Add unread badge if not current chat
                if (!currentChatUser || currentChatUser.id !== userId) {
                    const unreadCount = unreadCounts[userId] || 0;
                    if (unreadCount > 0) {
                        let badge = conversationItem.querySelector('.unread-badge');
                        if (!badge) {
                            badge = document.createElement('div');
                            badge.className = 'unread-badge';
                            conversationItem.querySelector('.conversation-header').appendChild(badge);
                        }
                        badge.textContent = unreadCount;
                        badge.style.display = 'block';
                    }
                }
                
                // Move to top
                container.insertBefore(conversationItem, container.firstChild);
            }
        }
        
        // Clear unread count when opening chat
        function clearUnreadCount(userId) {
            unreadCounts[userId] = 0;
            
            // Clear from storage for profile page sync
            try {
                localStorage.removeItem(`unreadCount_${userId}`);
            } catch (e) {
                try {
                    sessionStorage.removeItem(`unreadCount_${userId}`);
                } catch (e2) {}
            }
            
            updateConversationBadge(userId, 0);
            
            // Update lastMessageCheck only for this specific user's messages
            updateLastCheckForUser(userId);
        }
        
        // Update last check timestamp only for specific user
        async function updateLastCheckForUser(userId) {
            try {
                // Store per-user last read timestamp
                const lastReadKey = `lastRead_${userId}`;
                safeSetStorage(lastReadKey, Date.now().toString());
                console.log(`‚úÖ Updated last read time for user ${userId}`);
            } catch (error) {
                console.log('Error updating last check for user:', error);
            }
        }
        
        // Send button click handler
        document.getElementById('send-btn').addEventListener('click', function(e) {
            e.preventDefault();
            sendMessage();
        });
        
        // Enter key handler
        document.getElementById('chat-input').addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });
        
        // Auto-resize textarea
        document.getElementById('chat-input').addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = Math.min(this.scrollHeight, 120) + 'px';
        });

        // Search functionality
        let searchTimeout;
        let allUsersCache = []; // Cache all users for instant search clear
        
        // Make displayUsers function available globally for search
        function displayUsers(users) {
            const container = document.getElementById('conversationsList');
            if (!container) return;
            container.innerHTML = '';
            
            users.forEach(user => {
                const firstName = user.first_name || '';
                const lastName = user.last_name || '';
                const name = `${firstName} ${lastName}`.trim() || `User ${user.id}`;
                const avatar = user.profile_photo || `https://ui-avatars.com/api/?name=${encodeURIComponent(name)}&background=00a884&color=fff&size=50`;
                
                const userDiv = document.createElement('div');
                userDiv.className = 'conversation-item';
                userDiv.dataset.userId = user.id;
                userDiv.onclick = () => window.selectUser(user.id, name, avatar);
                
                userDiv.innerHTML = `
                    <div class="user-avatar">
                        <img src="${avatar}" alt="${name}" onerror="this.src='https://ui-avatars.com/api/?name=${encodeURIComponent(name)}&background=00a884&color=fff&size=50'">
                        <div class="user-status online"></div>
                    </div>
                    <div class="conversation-info">
                        <div class="conversation-header">
                            <div class="user-name">${name}</div>
                            <div class="meta-column">
                                <div class="message-time">${user.lastMessageTimeStr || 'online'}</div>
                                ${user.unreadCount > 0 ? `<div class="unread-badge">${user.unreadCount > 99 ? '99+' : user.unreadCount}</div>` : ''}
                            </div>
                        </div>
                        <div class="last-message">${user.lastMessageText || 'Click to start chatting'}</div>
                    </div>
                `;
                
                if (user.unreadCount > 0) {
                    userDiv.classList.add('has-unread');
                }
                
                container.appendChild(userDiv);
            });
        }
        
        document.getElementById('searchBox').addEventListener('input', function(e) {
            const searchTerm = e.target.value.toLowerCase().trim();
            const container = document.getElementById('conversationsList');
            
            clearTimeout(searchTimeout);
            
            if (!searchTerm) {
                // Restore cached users instantly
                if (allUsersCache.length > 0) {
                    displayUsers(allUsersCache);
                }
                return;
            }
            
            searchTimeout = setTimeout(() => {
                console.log('üîç Searching for:', searchTerm);
                fetch(`${SUPABASE_URL}/rest/v1/users?select=id,first_name,last_name,email,profile_photo&id=neq.${currentUserId}&or=(first_name.ilike.*${searchTerm}*,last_name.ilike.*${searchTerm}*,email.ilike.*${searchTerm}*)&limit=50`, {
                    headers: {
                        'apikey': SUPABASE_ANON_KEY,
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                        'Accept': 'application/json'
                    }
                })
                .then(res => res.json())
                .then(searchResults => {
                    if (searchResults.length === 0) {
                        container.innerHTML = '<div style="text-align:center;padding:2rem;color:#8696a0;">No users found</div>';
                        return;
                    }
                    
                    // Format search results with default values
                    const formattedResults = searchResults.map(user => ({
                        ...user,
                        lastMessageText: 'Click to start chatting',
                        lastMessageTimeStr: 'online',
                        unreadCount: 0
                    }));
                    
                    displayUsers(formattedResults);
                })
                .catch(error => console.log('Search error:', error));
            }, 300);
        });
        
        // Load users IMMEDIATELY - FASTEST APPROACH
        (function loadUsers() {
            const container = document.getElementById('conversationsList');
            if (!container) return;
            
            let currentUser = {};
            try {
                currentUser = JSON.parse(safeGetStorage('currentUser', '{}'));
            } catch (e) {
                currentUser = {};
            }
            const currentUserId = currentUser.id || 157;
            
            // Try to load from cache first
            const cachedUsers = safeGetStorage('cachedUsers', null);
            if (cachedUsers) {
                try {
                    const users = JSON.parse(cachedUsers);
                    displayUsers(users);
                    allUsersCache = users;
                    console.log('‚ö° Loaded from cache instantly');
                    // Still fetch fresh data in background
                    setTimeout(() => fetchUsers(container, currentUserId), 100);
                    return;
                } catch (e) {}
            }
            
            // Show skeleton
            container.innerHTML = `
                <div class="conversation-item" style="pointer-events:none;">
                    <div class="user-avatar" style="background:#2a3942;animation:pulse 1.5s infinite;"></div>
                    <div class="conversation-info" style="flex:1;">
                        <div style="height:16px;background:#2a3942;border-radius:4px;width:60%;margin-bottom:8px;animation:pulse 1.5s infinite;"></div>
                        <div style="height:14px;background:#2a3942;border-radius:4px;width:80%;animation:pulse 1.5s infinite;"></div>
                    </div>
                </div>
                `.repeat(5) + '<style>@keyframes pulse{0%,100%{opacity:1}50%{opacity:0.5}}</style>';
            
            fetchUsers(container, currentUserId);
        })();
        
        function fetchUsers(container, currentUserId) {
            console.log('üöÄ Starting user load...');
            const startTime = Date.now();
            
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 8000);
            
            const url = `${SUPABASE_URL}/rest/v1/users?select=id,first_name,last_name,profile_photo&order=id.asc&limit=15`;
            console.log('üì° Fetching:', url);
            
            fetch(url, {
                signal: controller.signal,
                headers: {
                    'apikey': SUPABASE_ANON_KEY,
                    'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                }
            })
            .then(res => {
                clearTimeout(timeoutId);
                const loadTime = Date.now() - startTime;
                console.log(`‚úÖ Response received in ${loadTime}ms, status: ${res.status}`);
                if (!res.ok) throw new Error(`HTTP ${res.status}`);
                return res.json();
            })
            .then(users => {
                const totalTime = Date.now() - startTime;
                console.log(`‚úÖ JSON parsed, users count: ${users?.length || 0}`);
                console.log(`‚úÖ Users loaded: ${users.length} in ${totalTime}ms`);
                
                // Filter out current user client-side
                const filteredUsers = users.filter(u => u.id !== currentUserId);
                
                if (filteredUsers.length === 0) {
                    container.innerHTML = '<div style="text-align:center;padding:1.5rem;color:#8696a0;">No users found</div>';
                    return;
                }
                
                const quickUsers = filteredUsers.map(user => ({
                    ...user,
                    lastMessageText: 'Click to start chatting',
                    lastMessageTimeStr: 'online',
                    unreadCount: 0
                }));
                
                displayUsers(quickUsers);
                allUsersCache = quickUsers;
                console.log('‚úÖ Users displayed on screen');
                
                // Cache for next visit
                safeSetStorage('cachedUsers', JSON.stringify(quickUsers));
                
                setTimeout(() => loadMessagesInBackground(quickUsers, currentUserId), 100);
            })
            .catch(error => {
                clearTimeout(timeoutId);
                const totalTime = Date.now() - startTime;
                console.error(`‚ùå Load failed after ${totalTime}ms:`, error.message);
                container.innerHTML = `<div style="text-align:center;padding:1.5rem;color:#e94560;">Failed to load users<br><small>${error.message}</small><br><a href="javascript:location.reload()" style="color:#00a884;cursor:pointer;">Refresh</a></div>`;
            });
        }
        
        // Background message loading
        function loadMessagesInBackground(users, currentUserId) {
            const oneDayAgo = new Date(Date.now() - 24 * 60 * 60 * 1000).toISOString();
            const userIds = users.map(u => u.id).join(',');
            
            fetch(`${SUPABASE_URL}/rest/v1/messages?or=(and(sender_id.in.(${userIds}),receiver_id.eq.${currentUserId}),and(sender_id.eq.${currentUserId},receiver_id.in.(${userIds})))&created_at=gte.${oneDayAgo}&order=created_at.desc&limit=30`, {
                headers: {
                    'apikey': SUPABASE_ANON_KEY,
                    'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                }
            })
            .then(res => res.json())
            .then(allMessages => {
                if (allMessages.length === 0) return;
                
                const readMessages = JSON.parse(safeGetStorage('readMessages', '[]'));
                const messagesByUser = new Map();
                
                allMessages.forEach(msg => {
                    const otherUserId = msg.sender_id === currentUserId ? msg.receiver_id : msg.sender_id;
                    if (!messagesByUser.has(otherUserId)) messagesByUser.set(otherUserId, []);
                    messagesByUser.get(otherUserId).push(msg);
                });
                
                const updatedUsers = users.map(user => {
                    const userMessages = messagesByUser.get(user.id) || [];
                    if (userMessages.length === 0) return { ...user, lastMessageTime: 0, lastMessageText: 'Click to start chatting', lastMessageTimeStr: 'online', unreadCount: 0 };
                    
                    const lastMessage = userMessages[0];
                    const unreadCount = userMessages.filter(m => m.sender_id === user.id && !readMessages.includes(m.id)).length;
                    
                    if (unreadCount > 0) {
                        unreadCounts[user.id] = unreadCount;
                        safeSetStorage(`unreadCount_${user.id}`, unreadCount.toString());
                    }
                    
                    return {
                        ...user,
                        lastMessageTime: new Date(lastMessage.created_at).getTime(),
                        lastMessageText: lastMessage.content.substring(0, 40) + (lastMessage.content.length > 40 ? '...' : ''),
                        lastMessageTimeStr: new Date(lastMessage.created_at).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}),
                        unreadCount: unreadCount
                    };
                });
                
                const sortedUsers = updatedUsers.sort((a, b) => {
                    if (a.unreadCount !== b.unreadCount) return b.unreadCount - a.unreadCount;
                    return b.lastMessageTime - a.lastMessageTime;
                });
                
                allUsersCache = sortedUsers;
                displayUsers(sortedUsers);
            })
            .catch(() => {});
        }
    </script>
</body>
</html>
